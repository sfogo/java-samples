<html>
<head>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/two.js"></script>
</head>
<body>
<div class="scripts">
    <script>
        class Point {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
            toString() {
                return '(' + this.x + ',' + this.y + ')';
            }
        }

        var PATHS = [];
        var GRID = {
            two: null,
            step: 40,
            margin: 10,
            w: 5,
            h: 4
        };

        $(function() {
            $('#top').append("<div>Hi!</div>");
            $('#logs').children().remove();

            $("#resume").click(function(event) {
                // alert(event.target.id);
                GRID.two.play();
            });

            $("#pause").click(function(event) {
                // alert(event.target.id);
                GRID.two.pause();
            });

            initGrid();
            getPaths(GRID.w, GRID.h);
        });

        function initGrid() {
            var width = 2*GRID.margin + GRID.w * GRID.step;
            var height = 2*GRID.margin + GRID.h * GRID.step;
            var elem = document.getElementById('draw-grid');
            var params = { width: width, height: height };
            GRID.two = new Two(params).appendTo(elem);

            // grid vertical lines
            for (var i=0; i < 1 + GRID.w; i++) {
                var p1 = convert(i, 0);
                var p2 = convert(i, GRID.h);
                GRID.two.makeLine(p1.x, p1.y, p2.x, p2.y);
            }

            // grid horizontal lines
            for (var i=0; i < 1 + GRID.h; i++) {
                var p1 = convert(0, i);
                var p2 = convert(GRID.w, i);
                GRID.two.makeLine(p1.x, p1.y, p2.x, p2.y);
            }

            GRID.two.update();
        }

        function convert(x,y) {
            // We want (0,0) to be bottom left of grid (and not top left),
            // Hence the translation from y to GRID.h - y
            return new Point(GRID.margin + x*GRID.step, GRID.margin + (GRID.h - y)*GRID.step);
        }

        function convertPoint(p) {
            return convert(p.x,p.y);
        }

        function makeGridDot(x,y) {
            var p = convert(x,y);
            var dot = GRID.two.makeCircle(p.x, p.y, 8);
            dot.fill = '#FF8000';
            return dot;
        }

        function makeGridDotFromPoint(p) {
            return makeGridDot(p.x,p.y);
        }

        function logPath(points) {
            var s = null;
            for (var i=0; i<points.length; i++) {
                var p = points[i];
                if (s == null) {
                    s = p.toString();
                } else {
                    s = s + ', ' + p.toString();
                }
            }
            log(s);
        }

        function log(s) {
            $('#logs').append('<div>' + s + '</div>');
        }

        function makePathsURL(w,h) {
            var u = '/things/paths/';
            u += ('?w=' + w);
            u += ('&h=' + h);
            return u;
        }

        function getPaths(w,h) {
            $.ajax({
                type: 'GET',
                url: makePathsURL(w,h),
                success: function(data,status,xhr) {
                    PATHS = data;
                    console.log('Found:'+PATHS.length);
                    playPaths();
                },
                error: function(xhr,status,error) {
                    console.log(status);
                }
            });
        }

        function playPaths() {
            var nbPaths = PATHS.length;
            var pathLength = PATHS[0].length;
            var p0 = PATHS[0][0];
            var dot0 = makeGridDot(p0.x, p0.y);
            GRID.two.update();
            var u = 0;
            var v = 1;
            GRID.two.bind('update', function(frameCount) {
                if (frameCount % 12 == 0) {
                    var next = PATHS[u][v];
                    var p = convertPoint(next);
                    dot0.translation.set(p.x, p.y);
                    v = (1 + v) % pathLength;
                    if (v == 0) {
                        u = (1 + u) % nbPaths;
                    }
                }
            }).play();
        }
    </script>
</div>
<div id="top"></div>
<div id="navigation">
    <button id="resume">Resume</button>
    <button id="pause">Pause</button>
</div>
<div id="draw-grid" style="border-style:solid;border-width:1px;border-color:#cccccc;"></div>
<div id="logs"></div>
</body>
</html>
